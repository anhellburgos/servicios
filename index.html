<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SIGSEP - Cortes de Energía CNELEP</title>
  <link rel="stylesheet" href="https://js.arcgis.com/4.25/esri/themes/light/main.css">
  <link rel="stylesheet" href="CSS/estilo.css">
  <script src="https://js.arcgis.com/4.25/"></script>
  <style>
    #map {
      height: 100%;
      width: 100%;
      position: relative;
      background-color: #0072bc;
    }
    
    body, html {
      height: 100%;
      margin: 0;
      display: flex;
      flex-direction: column;
      color: white;
      font-size: 0.8rem;
    }
    
    .content {
      flex: 1;
      position: relative;
    }
    
    footer {
      background-color: #0072bc;
      color: white;
      padding: 8px;
      text-align: left;
      font-size: 0.7rem;
      line-height: 1.2;
    }
    
    .map-dropdown {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 999;
    }

    .form-select {
      width: 170px;
      margin-top: 10px;
    }

    .navbar-title {
      font-size: 1.3rem;
      display: flex;
      align-items: center;
    }

    .navbar img {
      height: 40px;
      margin-right: 10px;
      padding: 10px;  
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-light" style="background-color: #0072bc; color: white;">
    <div class="container-fluid">
      <div class="navbar-title">
        <img src="logosegura.png" alt="Logo" />
        <span>CORTES DE ENERGÍA PROGRAMADOS EN EL CANTÓN GUAYAQUIL DEL 9 AL 13 DE OCTUBRE</span>
      </div>
    </div>
  </nav>
    
  <div class="content">
    <div id="map">
      <div class="map-dropdown">
        <select class="form-select" id="selectFecha">
          <option value="">Seleccione una fecha</option>
          <option value="09-10-2024">09/10/2024</option>
          <option value="10-10-2024">10/10/2024</option>
          <option value="11-10-2024">11/10/2024</option>
          <option value="12-10-2024">12/10/2024</option>
          <option value="13-10-2024">13/10/2024</option>
        </select>
        <select class="form-select" id="selectHora" style="display: none;">
          <option value="">Seleccione una fecha</option>
        </select>
      </div>
    </div>
  </div>

  <footer>
    Fuente: <a href="https://drive.google.com/file/d/12mJQArraDREmdM1uqlugeRt25enWc0h_/view" style="color: white;" target="_blank">Corporación Nacional de Electricidad - CENELEP</a>
    <br>  
    Consulta tu horario con: <a href="https://serviciosenlinea.cnelep.gob.ec/cortes-energia/" style="color: white;" target="_blank">Servicios en Linea CENELEP</a>
    <br>
    Elaborado por: Coordinación Técnica de Estadística y Datos - Sistema de Información Geográfica
  </footer>

  <script>
    require([
      "esri/Map",
      "esri/views/MapView",
      "esri/layers/GeoJSONLayer",
      "esri/symbols/SimpleFillSymbol",
      "esri/widgets/BasemapGallery",
      "esri/widgets/Expand",
      "esri/widgets/Locate",
      "esri/widgets/Search" // Importa el widget de búsqueda
    ], function(Map, MapView, GeoJSONLayer, SimpleFillSymbol, BasemapGallery, Expand, Locate, Search) {

      const geojsonLayers = {
        "09-10-2024": new GeoJSONLayer({
          url: "cortes20241009.geojson",
          renderer: createRenderer([0, 0, 255, 0.2]),
          popupTemplate: createPopupTemplate()
        }),
        "10-10-2024": new GeoJSONLayer({
          url: "cortes20241010.geojson",
          renderer: createRenderer([255, 10, 0, 0.2]),
          popupTemplate: createPopupTemplate()
        }),
        "11-10-2024": new GeoJSONLayer({
          url: "cortes20241011.geojson",
          renderer: createRenderer([0, 128, 0, 0.2]),
          popupTemplate: createPopupTemplate()
        }),
        "12-10-2024": new GeoJSONLayer({
          url: "cortes20241012.geojson",
          renderer: createRenderer([128, 0, 128, 0.2]),
          popupTemplate: createPopupTemplate()
        }),
        "13-10-2024": new GeoJSONLayer({
          url: "cortes20241013.geojson",
          renderer: createRenderer([255, 0, 0, 0.2]),
          popupTemplate: createPopupTemplate()
        })
      };

      const map = new Map({ basemap: "streets", layers: [] });
      const view = new MapView({
        container: "map",
        map: map,
        center: [-79.9595, -2.1200],
        zoom: 11
      });

      // Widget de búsqueda
      const searchWidget = new Search({
        view: view
      });

      const locateWidget = new Locate({
        view: view,
        useTracking: true
      });

      // Agrega el widget de búsqueda y de geolocalización
      view.ui.add(locateWidget, "bottom-right");
      //view.ui.add(searchWidget, "bottom-right"); // Añadir debajo del widget de geolocalización

      const basemapGallery = new BasemapGallery({
        view: view,
        container: document.createElement("div")
      });
      const basemapExpand = new Expand({
        view: view,
        content: basemapGallery,
        expandIconClass: "esri-icon-basemap"
      });
      view.ui.add(basemapExpand, "bottom-left");

      document.getElementById("selectFecha").addEventListener("change", function() {
        const selectedDate = this.value;
        updateHoraOptions(selectedDate);
        updateMap(selectedDate, null);
      });

      document.getElementById("selectHora").addEventListener("change", function() {
        const selectedDate = document.getElementById("selectFecha").value;
        const selectedHora = this.value;
        updateMap(selectedDate, selectedHora);
      });

      function updateHoraOptions(selectedDate) {
        const horaSelect = document.getElementById("selectHora");
        horaSelect.innerHTML = '<option value="">Seleccione una hora</option>';
        
        fetchUniqueHours(selectedDate).then(hours => {
          hours.forEach(hour => {
            horaSelect.append(new Option(hour, hour));
          });
          horaSelect.style.display = hours.length ? 'block' : 'none';
        });
      }

      function fetchUniqueHours(date) {
        const layer = geojsonLayers[date];
        return layer.queryFeatures({ outFields: ["Horario_1", "Horario_2"], returnDistinctValues: true })
          .then(result => {
            const hours = new Set();
            result.features.forEach(feature => {
              const h1 = feature.attributes.Horario_1;
              const h2 = feature.attributes.Horario_2;
              if (h1 && h1 !== "SIN CORTE") hours.add(h1);
              if (h2 && h2 !== "SIN CORTE") hours.add(h2);
            });
            return Array.from(hours).sort();
          });
      }

      function updateMap(selectedDate, selectedHour) {
        map.removeAll();

        if (selectedDate && geojsonLayers[selectedDate]) {
          const layer = geojsonLayers[selectedDate];
          map.add(layer);

          if (selectedHour) {
            layer.definitionExpression = `Horario_1 = '${selectedHour}' OR Horario_2 = '${selectedHour}'`;
          } else {
            layer.definitionExpression = "1=1";
          }

          view.goTo({ target: layer.fullExtent, zoom: 11 });
        }
      }

      function createRenderer(fillColor) {
        return {
          type: "simple",
          symbol: createSymbol(fillColor)
        };
      }

      function createSymbol(fillColor, outlineColor = fillColor, outlineWidth = 0.5) {
        return new SimpleFillSymbol({
          color: fillColor,
          outline: { color: outlineColor, width: outlineWidth }
        });
      }

      function createPopupTemplate() {
        return {
          title: "Resumen Informativo",
          content: `
            <b>Sector:</b><br>{SECTORES}<br>
            <b>Horario 1:</b> {Horario_1}<br>
            <b>Horario 2:</b> {Horario_2}`
        };
      }
    });
  </script>
</body>
</html>
