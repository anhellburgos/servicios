<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Esri Map - GeoJSON Layer (Cortes)</title>
  <link rel="stylesheet" href="https://js.arcgis.com/4.25/esri/themes/light/main.css">
  <link rel="stylesheet" href="CSS/estilo.css">
  <script src="https://js.arcgis.com/4.25/"></script>
</head>
<body>
  <div id="navbar">SIG-S</div>
  <div id="container">
    <div id="viewDiv"></div>
    <div id="widgetsContainer">
      <select id="selectHorario1" class="esri-select"></select>
      <select id="selectHorario2" class="esri-select"></select>
      <!-- Si decides añadir un tercer horario, descomenta la siguiente línea -->
      <!-- <select id="selectHorario3" class="esri-select"></select> -->
    </div>
  </div>

  <script>
    require([
      "esri/Map",
      "esri/views/MapView",
      "esri/layers/GeoJSONLayer",
      "esri/symbols/SimpleFillSymbol",
      "esri/widgets/BasemapGallery",
      "esri/widgets/Expand",
      "esri/widgets/Locate"
    ], function(Map, MapView, GeoJSONLayer, SimpleFillSymbol, BasemapGallery, Expand, Locate) {
      
      const geojsonLayer = new GeoJSONLayer({
        url: "cortes.geojson",
        renderer: createRenderer(),
        popupTemplate: {
          title: "Información",
          content: `<b>Horario 1:</b> {Horario_1}<br><b>Horario 2:</b> {Horario_2}`
        }
      });

      const map = new Map({ basemap: "hybrid", layers: [geojsonLayer] });
      const view = new MapView({
        container: "viewDiv",
        map: map,
        center: [-79.9595, -2.1200],
        zoom: 11
      });

      view.ui.add(createBasemapGallery(view), "bottom-left");
      view.ui.add(new Locate({ view: view, useTracking: true }), "top-right");

      initializeSelects();

      function createSymbol(fillColor, outlineColor = fillColor, outlineWidth = 0.5) {
        return new SimpleFillSymbol({
          color: fillColor,
          outline: { color: outlineColor, width: outlineWidth }
        });
      }

      function createRenderer() {
        return {
          type: "simple",
          symbol: createSymbol([0, 0, 255, 0.2])
        };
      }

      function createBasemapGallery(view) {
        return new Expand({ 
          view: view, 
          content: new BasemapGallery({ view: view }), 
          expanded: false 
        });
      }

      function updateSelect(element, options, defaultText) {
        element.innerHTML = `<option value="">${defaultText}</option>`;
        options.forEach(option => element.append(new Option(option, option)));
      }

      function updateMap(horario1, horario2) {
        const expressions = [];
        if (horario1) expressions.push(`Horario_1 = '${horario1}'`);
        if (horario2) expressions.push(`Horario_2 = '${horario2}'`);

        geojsonLayer.definitionExpression = expressions.length ? expressions.join(" OR ") : "1=1";

        const rendererField = horario2 ? "Horario_2" : "Horario_1";

        geojsonLayer.renderer = {
          type: "unique-value",
          field: rendererField,
          uniqueValueInfos: [{
            value: horario2 || horario1,
            symbol: createSymbol([255, 0, 0, 0.5], [255, 255, 255, 1])
          }],
          defaultSymbol: createSymbol([0, 0, 255, 0.2])
        };

        geojsonLayer.queryFeatures().then(results => {
          if (results.features.length) {
            const extent = results.features.reduce((ext, feature) => ext ? ext.union(feature.geometry.extent) : feature.geometry.extent, null);
            if (extent) view.goTo(extent.expand(1.5)).catch(console.error);
          }
        }).catch(console.error);
      }

      function initializeSelects() {
        const selectHorario1 = document.getElementById("selectHorario1");
        const selectHorario2 = document.getElementById("selectHorario2");
        // En caso de un tercer horario, añadir el siguiente código
        // const selectHorario3 = document.getElementById("selectHorario3");

        fetchUniqueValues("Horario_1").then(horarios1 => {
          updateSelect(selectHorario1, horarios1, "TODOS LOS HORARIOS 1");
        });

        fetchUniqueValues("Horario_2").then(horarios2 => {
          const filteredHorarios2 = horarios2.filter(h => h !== "SIN CORTE");
          updateSelect(selectHorario2, filteredHorarios2, "TODOS LOS HORARIOS 2");
        });

        selectHorario1.addEventListener("change", function() {
          const selectedHorario1 = this.value;
          selectHorario2.selectedIndex = 0;
          // En caso de un tercer horario, añadir el siguiente código
          // selectHorario3.selectedIndex = 0;
          updateMap(selectedHorario1, null);
        });

        selectHorario2.addEventListener("change", function() {
          const selectedHorario2 = this.value;
          selectHorario1.selectedIndex = 0; 
          // En caso de un tercer horario, añadir el siguiente código
          // selectHorario3.selectedIndex = 0;
          updateMap(null, selectedHorario2);
        });

        // En caso de un tercer horario, añadir el siguiente código
        // selectHorario3.addEventListener("change", function() {
        //   const selectedHorario3 = this.value;
        //   selectHorario1.selectedIndex = 0; 
        //   selectHorario2.selectedIndex = 0; 
        //   updateMap(null, null, selectedHorario3);
        // });
      }

      function fetchUniqueValues(field) {
        return geojsonLayer.queryFeatures({ outFields: [field], returnDistinctValues: true })
          .then(result => Array.from(new Set(result.features.map(f => f.attributes[field]))).sort());
      }
    });
  </script>
</body>
</html>
